<!DOCTYPE html>
<html>
<head>
  <script src="//cdn.jsdelivr.net/npm/phaser@3.6.1/dist/phaser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.5.1/dat.gui.js"></script>
  <script src="RailBuilder.js" type="module"></script>
</head>
<body>

<script type="module">
  import  {RailBuilder}  from "./RailBuilder.js";
  import  {CameraController}  from "./CameraController.js";

  let WIDTH = 800;
  let HEIGHT = 640;
  let TILESIZE = 32;

  let config = {
    type: Phaser.AUTO,
    width: WIDTH,
    height: HEIGHT,
    disableContextMenu: true,
    scene: {
      initialize: initialize,
      preload: preload,
      create: create,
      update: update
    }
  };

  var game = new Phaser.Game(config);

  function initialize() {
  }

  function preload() {
    this.load.image('rail', 'assets/rail.png');
    this.load.image('railturn', 'assets/railturn.png');
    this.load.image('halfrail', 'assets/halfrail.png');
  }

  class Coordinates {
    constructor(pointer, camera) {
      this.x = Math.round((pointer.x + camera.scrollX) / TILESIZE) * TILESIZE;
      this.y = Math.round((pointer.y + camera.scrollY) / TILESIZE) * TILESIZE;
    }
  }

  function create() {
    // To add a static sprite for GUI, use this.add.image(...).setScrollFactor(0)

    this.cameras.main.setBounds(-200, -200, 1000, 1000);
    this.cameraController = new CameraController();
    this.grid = {};
    this.railBuilder = new RailBuilder(this.grid, TILESIZE);
    this.temporaryRailImages = [];

    this.input.on('pointerdown', function (pointer) {
      if (pointer.buttons == 1) {
        this.railBuilder.pointerDown(new Coordinates(pointer, this.cameras.main))
      } else if (pointer.buttons == 2) {
        this.cameraController.pointerDown(pointer);
      }
    }, this);

    this.input.on('pointerup', function (pointer) {
      this.cameraController.pointerUp();
      let successful = this.railBuilder.pointerUp();
      if (successful) {
        // Clear the array so that the images will not be destroyed
        this.temporaryRailImages = [];
      }
    }, this);

    this.input.on('pointermove', function (pointer) {
      // pointermove is called after pointerup when the mouse cursor is released,
      // so this will remove the temporary rail images unless the array is cleared
      // by a successful build action.
      for (var image of this.temporaryRailImages) {
        image.destroy()
      }
      let images = this.railBuilder.pointerMove(new Coordinates(pointer, this.cameras.main), this);
      if (images) {
        for (let image of images) {
          let railImage = this.add.image(image.x, image.y, image.name);
          railImage.angle = image.angle;
          railImage.tint = image.tint;
          this.temporaryRailImages.push(railImage);
        }
      }
      // Note: pointer.buttons == 2 is not checked here. The reason is that
      // pointer.buttons will be the last button pressed. E.g., if button 2 is pressed, released
      // and then the pointer is moved, pointer.buttons will still be 2 until another button is pressed.
      // So it is only a small optimization to do that check.
      let [scrollXchange, scrollYchange] = this.cameraController.pointerMove(pointer);
      this.cameras.main.scrollX -= scrollXchange;
      this.cameras.main.scrollY -= scrollYchange;
    }, this);

    let gui = new dat.GUI();
    let cam = this.cameras.main;

    let f1 = gui.addFolder('Camera');
    f1.add(cam, 'x').listen();
    f1.add(cam, 'y').listen();
    f1.add(cam, 'scrollX').listen();
    f1.add(cam, 'scrollY').listen();
    f1.add(cam, 'rotation').min(0).step(0.01).listen();
    f1.open();
    let f2 = gui.addFolder('Other');
    f2.add(this, '_draggingCamera').listen();
    f2.add(this.railBuilder, 'building').listen();
    f2.open();
  }

  function update() {
  }
</script>

</body>
</html>